<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指導予約システム</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        h3 { text-align: center; color: #1a73e8; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .info { font-size: 0.85em; color: #666; margin-bottom: 8px; font-weight: bold; }
        select { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; background-color: #fff; -webkit-appearance: none; appearance: none; }
        button { width: 100%; padding: 14px; margin-top: 15px; border-radius: 8px; border: none; background: #00b900; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { background: #009e00; transform: scale(0.98); }
        #seniorList { margin-top: 20px; }
        .senior-card { border-left: 5px solid #00b900; }
        .admin-link { font-size: 0.8em; text-align: center; margin-top: 30px; color: #999; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>
    <h3>指導予約</h3>
    
    <div class="card">
        <div class="info">① 日付を選択</div>
        <select id="dateInput" onchange="fetchSchedule()">
            <option value="">読み込み中...</option>
        </select>
    </div>

    <div id="seniorList"></div>

    <div class="admin-link" onclick="showAdmin()">2年生の方（ID登録）はこちら</div>

    <script>
        const LIFF_ID = "2008788046-laPjP0Ec"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbygJQBKh1xIEQZUJ0CykesxFKLm9PYO3UG4U45f87W5h-qEj2HsqhE2QlP3dX-iFJHV/exec"; 

        // --- 1. 日付プルダウンを即座に作成する関数 ---
        function initDatePicker() {
            const dateInput = document.getElementById('dateInput');
            dateInput.innerHTML = ""; // 「読み込み中」を消す
            
            const today = new Date();
            const dayNames = ["日", "月", "火", "水", "木", "金", "土"];

            for (let i = 1; i <= 30; i++) {
                const targetDate = new Date();
                targetDate.setDate(today.getDate() + i);

                const y = targetDate.getFullYear();
                const m = ("0" + (targetDate.getMonth() + 1)).slice(-2);
                const d = ("0" + targetDate.getDate()).slice(-2);
                
                const val = `${y}-${m}-${d}`; 
                const label = `${targetDate.getMonth() + 1}/${targetDate.getDate()}(${dayNames[targetDate.getDay()]})`;

                const opt = document.createElement('option');
                opt.value = val;
                opt.text = label;
                dateInput.appendChild(opt);
            }
        }

        // --- 2. メイン処理 ---
        async function main() {
            // まず日付を出す（LIFFを待たない）
            initDatePicker();

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // ログイン済みなら、初期表示の日付でスケジュールを取得
                    fetchSchedule();
                }
            } catch (error) {
                console.error("LIFF Init Error:", error);
                // エラー時でもスケジュール取得だけは試みる
                fetchSchedule();
            }
        }

        async function fetchSchedule() {
            const date = document.getElementById('dateInput').value;
            if (!date) return;
            document.getElementById('seniorList').innerHTML = "空き状況を確認中...";
            
            try {
                const res = await fetch(`${GAS_URL}?action=getSchedule&date=${date}`);
                const data = await res.json();
                
                let html = '';
                data.forEach(senior => {
                    html += `
                    <div class="card senior-card">
                        <strong style="font-size: 1.1em;">${senior.name} 先輩</strong>
                        <div style="margin-top:10px;" class="info">開始時間</div>
                        <select id="time-${senior.name}">
                            ${senior.slots.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                        <div style="margin-top:10px;" class="info">指導時間</div>
                        <select id="duration-${senior.name}">
                            <option value="1">30分</option>
                            <option value="2">1時間</option>
                            <option value="3">1.5時間</option>
                            <option value="4">2時間</option>
                        </select>
                        <button onclick="reserve('${senior.name}')">この内容で予約する</button>
                    </div>`;
                });
                document.getElementById('seniorList').innerHTML = html || '<p style="text-align:center;">この日の空きはありません</p>';
            } catch (e) {
                document.getElementById('seniorList').innerHTML = "空き状況を取得できませんでした。";
            }
        }

        async function reserve(seniorName) {
            if (!confirm(`${seniorName} 先輩に予約を入れますか？`)) return;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById(`time-${seniorName}`).value;
            const duration = document.getElementById(`duration-${seniorName}`).value;
            
            let user;
            try {
                user = await liff.getProfile();
            } catch(e) {
                alert("ユーザー情報の取得に失敗しました。再ログインしてください。");
                return;
            }

            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    seniorName, date, time, duration,
                    juniorName: user.displayName, juniorId: user.userId
                })
            });
            
            if (res.ok) {
                alert('予約完了！LINE通知を確認してください。');
                liff.closeWindow();
            } else {
                alert('予約に失敗しました。既に埋まっている可能性があります。');
            }
        }

        async function showAdmin() {
            try {
                const res = await fetch(`${GAS_URL}?action=getSeniors`);
                const seniors = await res.json();
                let name = prompt("自分の名前を選んで入力してください:\n\n" + seniors.map(s => s[0]).join(", "));
                if (name) {
                    const user = await liff.getProfile();
                    await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'registerID', name: name, userId: user.userId })
                    });
                    alert(name + " 先輩のIDを登録しました。");
                }
            } catch (e) { alert("ID登録中にエラーが発生しました。"); }
        }

        // 実行開始
        main();
    </script>
</body>
</html>
