<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指導予約</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 15px; margin: 0; }
        .header { background: white; padding: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin: -15px -15px 20px -15px; text-align: center; }
        .filter-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; margin-top: 5px; background: #fff; }
        
        /* タイル表示のグリッド */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .time-tile { background: white; padding: 12px; border-radius: 10px; border: 1px solid #eee; min-height: 90px; }
        .time-label { display: block; font-weight: bold; color: #1a73e8; font-size: 1.1em; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; }
        
        /* 先輩アイコン */
        .icon-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .avatar { 
            width: 32px; height: 32px; border-radius: 50%; background: #00b900; color: white; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;
        }
        .avatar:active { opacity: 0.6; }
        .no-data { grid-column: span 2; text-align: center; padding: 50px; color: #999; }
    </style>
</head>
<body>
    <div class="header"><h3>指導予約</h3></div>
    
    <div class="filter-card">
        <label style="font-size:0.8em; color:#666;">日付を選択</label>
        <select id="dateInput" onchange="fetchSchedule()"></select>
        <label style="font-size:0.8em; color:#666; margin-top:10px; display:block;">先輩で絞り込む</label>
        <select id="seniorFilter" onchange="renderGrid()"><option value="all">全員表示</option></select>
    </div>

    <div id="scheduleGrid" class="grid"></div>

    <script>
        const LIFF_ID = "2008788046-laPjP0Ec";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz9r5UGsU4tg1FsFiW_rauxNjNlZINnmsoAoZwcYrqSZCtYx1VBbf5aKwR3xN1LA96d/exec";
        let scheduleData = [];

        async function main() {
            initDates();
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            
            // 先輩リストを取得
            const res = await fetch(`${GAS_URL}?action=getSeniors`);
            const seniors = await res.json();
            const filter = document.getElementById('seniorFilter');
            seniors.forEach(s => {
                const opt = document.createElement('option'); opt.value = s[0]; opt.text = s[0];
                filter.appendChild(opt);
            });
            fetchSchedule();
        }

        function initDates() {
            const input = document.getElementById('dateInput');
            let d = new Date(2026, 3, 2); const end = new Date(2026, 6, 31);
            while(d <= end) {
                const opt = document.createElement('option');
                const val = `${d.getFullYear()}-${("0"+(d.getMonth()+1)).slice(-2)}-${("0"+d.getDate()).slice(-2)}`;
                opt.value = val; opt.text = `${d.getMonth()+1}/${d.getDate()}`;
                input.appendChild(opt); d.setDate(d.getDate()+1);
            }
        }

        async function fetchSchedule() {
            const date = document.getElementById('dateInput').value;
            document.getElementById('scheduleGrid').innerHTML = "<div class='no-data'>読み込み中...</div>";
            const res = await fetch(`${GAS_URL}?action=getSchedule&date=${date}`);
            scheduleData = await res.json();
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('scheduleGrid');
            const filter = document.getElementById('seniorFilter').value;
            grid.innerHTML = "";

            // 表示する時間枠（スプレッドシートに合わせて設定）
            const times = ["8:30","9:00","9:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30"];

            times.forEach(t => {
                let available = scheduleData.filter(s => s.slots.includes(t));
                if (filter !== "all") { available = available.filter(s => s.name === filter); }

                if (available.length > 0) {
                    const tile = document.createElement('div');
                    tile.className = "time-tile";
                    let icons = available.map(s => `<div class="avatar" onclick="reserve('${s.name}','${t}')">${s.name[0]}</div>`).join('');
                    tile.innerHTML = `<span class="time-label">${t}</span><div class="icon-list">${icons}</div>`;
                    grid.appendChild(tile);
                }
            });
            if (!grid.innerHTML) grid.innerHTML = "<div class='no-data'>空きがありません</div>";
        }

        async function reserve(name, time) {
            const dur = prompt(`${name}先輩への予約\n指導時間(1:30分, 2:1時間, 4:2時間)`, "2");
            if (!dur) return;
            const user = await liff.getProfile();
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ seniorName:name, date:document.getElementById('dateInput').value, time:time, duration:dur, juniorName:user.displayName, juniorId:user.userId })
            });
            if (res.ok) { alert('予約完了！'); liff.closeWindow(); }
        }
        main();
    </script>
</body>
</html>

