<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指導予約システム</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .info { font-size: 0.8em; color: #666; font-weight: bold; margin-bottom: 5px; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; margin-bottom: 10px; }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; background: #00b900; color: white; font-weight: bold; }
        .senior-name { font-size: 1.1em; color: #1a73e8; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h3>指導予約</h3>
    
    <div class="card">
        <div class="info">① 日付を選択</div>
        <select id="dateInput" onchange="fetchSchedule()"></select>
        
        <div class="info">② 開始時間を選択</div>
        <select id="timeInput" onchange="filterSeniors()">
            <option value="17:00">17:00</option><option value="17:30">17:30</option>
            <option value="18:00">18:00</option><option value="18:30">18:30</option>
            <option value="19:00">19:00</option><option value="19:30">19:30</option>
            <option value="20:00">20:00</option><option value="20:30">20:30</option>
            <option value="21:00">21:00</option><option value="21:30">21:30</option>
        </select>
    </div>

    <div id="seniorList"></div>

    <script>
        const LIFF_ID = "2008788046-laPjP0Ec"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbygJQBKh1xIEQZUJ0CykesxFKLm9PYO3UG4U45f87W5h-qEj2HsqhE2QlP3dX-iFJHV/exec"; 
        let allSeniorsData = []; // 取得したデータを一時保存

        async function main() {
            initDatePicker();
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); } else { fetchSchedule(); }
        }

        function initDatePicker() {
            const dateInput = document.getElementById('dateInput');
            const now = new Date();
            let start = new Date(2026, 3, 2); 
            const end = new Date(2026, 6, 31);
            const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1);
            if (tomorrow > start) start = tomorrow;
            const dayNames = ["日", "月", "火", "水", "木", "金", "土"];

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const opt = document.createElement('option');
                opt.value = `${d.getFullYear()}-${("0"+(d.getMonth()+1)).slice(-2)}-${("0"+d.getDate()).slice(-2)}`;
                opt.text = `${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]})`;
                dateInput.appendChild(opt);
            }
        }

        async function fetchSchedule() {
            const date = document.getElementById('dateInput').value;
            document.getElementById('seniorList').innerHTML = "確認中...";
            const res = await fetch(`${GAS_URL}?action=getSchedule&date=${date}`);
            allSeniorsData = await res.json();
            filterSeniors(); // 取得したら今の時間設定でフィルタリング
        }

        function filterSeniors() {
            const selectedTime = document.getElementById('timeInput').value;
            const container = document.getElementById('seniorList');
            // 指定した時間に「o」がある先輩だけ抽出
            const available = allSeniorsData.filter(s => s.slots.includes(selectedTime));

            let html = '';
            available.forEach(s => {
                html += `<div class="card">
                    <strong class="senior-name">${s.name} 先輩</strong>
                    <div class="info">指導時間を選択</div>
                    <select id="dur-${s.name}">
                        <option value="1">30分</option><option value="2">1時間</option>
                        <option value="3">1.5時間</option><option value="4">2時間</option>
                    </select>
                    <button onclick="reserve('${s.name}')">予約する</button>
                </div>`;
            });
            container.innerHTML = html || '<p style="text-align:center;">この時間は誰も空いていません</p>';
        }

        async function reserve(name) {
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const duration = document.getElementById(`dur-${name}`).value;
            const user = await liff.getProfile();
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ seniorName:name, date:date, time:time, duration:duration, juniorName:user.displayName, juniorId:user.userId })
            });
            if (res.ok) { alert('予約完了！'); liff.closeWindow(); } else { alert('失敗。枠が埋まった可能性があります。'); }
        }
        main();
    </script>
</body>
</html>
