<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡å°äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f4f7f9; color: #333; }
        h3 { text-align: center; font-size: 1.2em; color: #333; margin-bottom: 20px; }
        .filter-section { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .label { font-size: 0.8em; font-weight: bold; color: #888; margin-bottom: 5px; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; background: #fff; margin-bottom: 10px; }
        
        /* ã‚¿ã‚¤ãƒ«ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰è¡¨ç¤º */
        .time-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .time-card { background: white; padding: 12px; border-radius: 10px; border: 1px solid #eee; position: relative; min-height: 80px; transition: 0.2s; }
        .time-label { font-weight: bold; font-size: 1.1em; color: #1a73e8; margin-bottom: 8px; display: block; }
        .slot-info { font-size: 0.7em; color: #999; margin-bottom: 8px; }

        /* å…ˆè¼©ã‚¢ã‚¤ã‚³ãƒ³ */
        .icon-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .senior-icon { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: #00b900; color: white; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.8em; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .senior-icon:active { transform: scale(0.9); }
        
        .no-data { grid-column: span 2; text-align: center; padding: 40px; color: #999; }
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.8em; color: #bbb; text-decoration: underline; }
    </style>
</head>
<body>
    <h3>ğŸ“… æŒ‡å°äºˆç´„</h3>
    
    <div class="filter-section">
        <div class="label">æ—¥ä»˜ã‚’é¸æŠ</div>
        <select id="dateInput" onchange="fetchSchedule()"></select>
        
        <div class="label">å…ˆè¼©ã§çµã‚Šè¾¼ã‚€ï¼ˆã‚½ãƒ¼ãƒˆï¼‰</div>
        <select id="seniorFilter" onchange="renderGrid()">
            <option value="all">å…¨å“¡è¡¨ç¤º</option>
        </select>
    </div>

    <div id="timeGrid" class="time-grid">
        </div>

    <div class="admin-link" onclick="showAdmin()">2å¹´ç”ŸIDç™»éŒ²</div>

    <script>
        const LIFF_ID = "2008788046-laPjP0Ec";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbygJQBKh1xIEQZUJ0CykesxFKLm9PYO3UG4U45f87W5h-qEj2HsqhE2QlP3dX-iFJHV/exec";
        
        let allSeniors = []; // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿãƒ‡ãƒ¼ã‚¿
        const TIMES = ["17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30"];

        async function main() {
            initDatePicker();
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            
            // å…ˆè¼©åç°¿ã‚’å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç”Ÿæˆ
            const res = await fetch(`${GAS_URL}?action=getSeniors`);
            const seniors = await res.json();
            const filter = document.getElementById('seniorFilter');
            seniors.forEach(s => {
                const opt = document.createElement('option'); opt.value = s[0]; opt.text = s[0];
                filter.appendChild(opt);
            });
            
            fetchSchedule();
        }

        function initDatePicker() {
            const dateInput = document.getElementById('dateInput');
            let d = new Date(2026, 3, 2); const end = new Date(2026, 6, 31);
            const now = new Date(); const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1);
            if (tomorrow > d) d = tomorrow;
            const dayNames = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
            while(d <= end) {
                const opt = document.createElement('option');
                opt.value = `${d.getFullYear()}-${("0"+(d.getMonth()+1)).slice(-2)}-${("0"+d.getDate()).slice(-2)}`;
                opt.text = `${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]})`;
                dateInput.appendChild(opt); d.setDate(d.getDate()+1);
            }
        }

        async function fetchSchedule() {
            const date = document.getElementById('dateInput').value;
            document.getElementById('timeGrid').innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";
            const res = await fetch(`${GAS_URL}?action=getSchedule&date=${date}`);
            allSeniors = await res.json();
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('timeGrid');
            const filterName = document.getElementById('seniorFilter').value;
            grid.innerHTML = "";

            TIMES.forEach(time => {
                // ãã®æ™‚é–“ã«ç©ºã„ã¦ã„ã‚‹å…ˆè¼©ã‚’æŠ½å‡º
                let availableSeniors = allSeniors.filter(s => s.slots.includes(time));
                
                // ã‚½ãƒ¼ãƒˆï¼ˆçµã‚Šè¾¼ã¿ï¼‰ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (filterName !== "all") {
                    availableSeniors = availableSeniors.filter(s => s.name === filterName);
                }

                if (availableSeniors.length > 0 || filterName === "all") {
                    const card = document.createElement('div');
                    card.className = "time-card";
                    
                    let iconsHtml = availableSeniors.map(s => 
                        `<div class="senior-icon" onclick="reserve('${s.name}', '${time}')" title="${s.name}">${s.name[0]}</div>`
                    ).join('');

                    card.innerHTML = `
                        <span class="time-label">${time}</span>
                        <div class="slot-info">ç©ºã: ${availableSeniors.length}å</div>
                        <div class="icon-container">${iconsHtml}</div>
                    `;
                    grid.appendChild(card);
                }
            });

            if (grid.innerHTML === "") {
                grid.innerHTML = "<div class='no-data'>æ¡ä»¶ã«åˆã†å…ˆè¼©ã¯ã„ã¾ã›ã‚“</div>";
            }
        }

        async function reserve(seniorName, time) {
            const dur = prompt(`${seniorName}å…ˆè¼©ã¸ã®äºˆç´„\næŒ‡å°æ™‚é–“ã‚’é¸ã‚“ã§ãã ã•ã„\n(1:30åˆ†, 2:1æ™‚é–“, 4:2æ™‚é–“)`, "2");
            if (!dur) return;

            const user = await liff.getProfile();
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    seniorName: seniorName,
                    date: document.getElementById('dateInput').value,
                    time: time,
                    duration: dur,
                    juniorName: user.displayName,
                    juniorId: user.userId
                })
            });
            if (res.ok) { alert('äºˆç´„å®Œäº†ï¼'); liff.closeWindow(); } else { alert('å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        }

        async function showAdmin() {
            const res = await fetch(`${GAS_URL}?action=getSeniors`);
            const seniors = await res.json();
            let name = prompt("è‡ªåˆ†ã®åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„:\n" + seniors.map(s => s[0]).join(", "));
            if (name) {
                const user = await liff.getProfile();
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'registerID', name: name, userId: user.userId }) });
                alert("ç™»éŒ²å®Œäº†");
            }
        }

        main();
    </script>
</body>
</html>
