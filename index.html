<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡å±±å¤§å­¦é¹¿ç”°å¼“é“éƒ¨ æŒ‡å°äºˆç´„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        [v-cloak] { display: none; }
        .slot-free { @apply bg-white text-emerald-600 border-emerald-100; }
        .slot-selected { @apply bg-emerald-500 text-white border-emerald-600 shadow-inner scale-95; }
        .slot-busy { @apply bg-slate-100 text-slate-300 border-slate-50 cursor-not-allowed; }
        .slot-mine { @apply bg-blue-500 text-white border-blue-600 font-bold; }
        .timeline-scroll::-webkit-scrollbar { height: 4px; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="app" v-cloak class="max-w-4xl mx-auto min-h-screen pb-32">
        <header class="bg-[#005a3c] text-white p-4 sticky top-0 z-40 shadow-md">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-lg font-bold">ğŸ¯ æŒ‡å°äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div class="text-right">
                    <p class="text-[10px] opacity-80">å²¡å±±å¤§å­¦é¹¿ç”°å¼“é“éƒ¨</p>
                    <p class="text-xs font-bold">{{ userName }} æ§˜</p>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="date" v-model="selectedDate" @change="loadData" class="flex-1 p-2 rounded text-black text-sm outline-none">
                <button @click="sortByName = !sortByName" class="bg-emerald-600 px-4 py-2 rounded text-xs font-bold active:bg-emerald-700 transition">
                    {{ sortByName ? 'åå‰é †ï¼šON' : 'åå‰é †ï¼šOFF' }}
                </button>
            </div>
        </header>

        <main class="p-2">
            <div v-if="loading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin h-10 w-10 border-4 border-emerald-500 border-t-transparent rounded-full mb-4"></div>
                <p class="text-emerald-600 font-bold">ç¨½å¤çŠ¶æ³ã‚’ç¢ºèªä¸­...</p>
            </div>

            <div v-else class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto timeline-scroll">
                    <div class="flex bg-slate-100 border-b border-slate-200">
                        <div class="w-20 flex-shrink-0 p-3 border-r bg-slate-200 sticky left-0 z-20 font-bold text-[10px] text-slate-600">æŒ‡å°è€…</div>
                        <div v-for="t in timeSlots" :key="t" class="w-14 flex-shrink-0 py-2 text-[10px] text-center border-r border-slate-200 text-slate-500 font-medium">
                            {{ t }}
                        </div>
                    </div>

                    <div v-for="teacher in sortedTeachers" :key="teacher.name" class="flex border-b border-slate-100 last:border-0">
                        <div class="w-20 flex-shrink-0 p-3 border-r bg-white sticky left-0 z-10 font-bold text-sm shadow-[2px_0_5px_rgba(0,0,0,0.02)] flex items-center">
                            {{ teacher.name }}
                        </div>
                        <div class="flex">
                            <div v-for="(status, index) in teacher.slots" 
                                 :key="index"
                                 @click="handleSlotClick(teacher, index)"
                                 :class="getSlotClass(teacher.name, index, status)"
                                 class="w-14 h-16 flex-shrink-0 border-r border-slate-100 flex items-center justify-center text-[10px] cursor-pointer transition-all relative">
                                <span v-if="status === 'o'" class="opacity-60">ç©ºã</span>
                                <span v-else-if="status === 'mine'" class="text-[8px] leading-tight text-center">è‡ªåˆ†ã®<br>äºˆç´„</span>
                                <span v-else class="text-slate-200">ãƒ¼</span>
                                
                                <div v-if="isSelected(teacher.name, index)" class="absolute inset-0 bg-emerald-500 text-white flex items-center justify-center font-bold shadow-inner">
                                    é¸æŠ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p v-if="!loading && sortedTeachers.length === 0" class="text-center py-10 text-slate-400">
                ã“ã®æ—¥ã®æŒ‡å°æ ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
            </p>
        </main>

        <div v-if="selection.start !== null" class="fixed bottom-0 left-0 right-0 z-50 p-4">
            <div class="bg-white rounded-2xl shadow-[0_-10px_40px_rgba(0,0,0,0.15)] border-t-4 border-emerald-500 p-5 max-w-md mx-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-black text-slate-800">{{ selection.teacherName }} å…ˆè¼©</h2>
                        <p class="text-emerald-600 font-bold">
                            {{ formatTime(selection.start) }} ã€œ {{ formatTime(selection.end + 1) }}
                            <span class="text-xs ml-2 text-slate-400">({{ (selection.end - selection.start + 1) * 30 }}åˆ†é–“)</span>
                        </p>
                    </div>
                    <button @click="resetSelection" class="bg-slate-100 text-slate-400 p-2 rounded-full">âœ•</button>
                </div>
                <button @click="submitBooking" :disabled="submitting" class="w-full bg-emerald-700 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition disabled:opacity-50">
                    {{ submitting ? 'å‡¦ç†ä¸­...' : 'äºˆç´„ã‚’ç¢ºå®šã™ã‚‹' }}
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®GAS URLã‚’è¨­å®š ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwY_M1JCvUOTz1ArJWCPcGpnkOOlOLRIZ1jZiT2OG-DlE8uRAZG2aBTj13YCxojqN0Y/exec";

        const { createApp, ref, computed, onMounted } = Vue;
        createApp({
            setup() {
                const userName = ref("èª­è¾¼ä¸­...");
                const userLineId = ref("");

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥ä»˜è¨­å®šãƒ­ã‚¸ãƒƒã‚¯
                const getInitialDate = () => {
                    const targetDate = new Date('2026-04-02T00:00:00');
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                    if (today < targetDate) {
                        return "2026-04-02";
                    } else {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        return tomorrow.toISOString().split('T')[0];
                    }
                };

                const selectedDate = ref(getInitialDate());
                const timeSlots = ["08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30"];
                const teachers = ref([]);
                const loading = ref(true);
                const submitting = ref(false);
                const sortByName = ref(false);
                const selection = ref({ teacherName: null, start: null, end: null });

                const loadData = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch(`${GAS_URL}?action=getSchedule&date=${selectedDate.value}&userId=${userLineId.value}`);
                        teachers.value = await response.json();
                    } catch (e) {
                        console.error("Data Fetch Error:", e);
                    }
                    loading.value = false;
                };

                const handleSlotClick = (teacher, index) => {
                    const status = teacher.slots[index];
                    if (status === 'mine') {
                        if(confirm(`${teacher.name}å…ˆè¼©ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) submitCancel(teacher.name, index);
                        return;
                    }
                    if (status !== 'o') return;

                    if (selection.value.teacherName !== teacher.name) {
                        selection.value = { teacherName: teacher.name, start: index, end: index };
                    } else {
                        if (index < selection.value.start) {
                            selection.value.start = index;
                        } else {
                            if (index - selection.value.start >= 4) {
                                alert("æœ€å¤§2æ™‚é–“ï¼ˆ4æ ï¼‰ã¾ã§ã§ã™ã€‚");
                                return;
                            }
                            for(let i=selection.value.start; i<=index; i++) {
                                if(teacher.slots[i] !== 'o') { alert("é€£ç¶šã—ãŸç©ºãæ ã®ã¿é¸æŠå¯èƒ½ã§ã™ã€‚"); return; }
                            }
                            selection.value.end = index;
                        }
                    }
                };

                const isSelected = (tName, idx) => selection.value.teacherName === tName && idx >= selection.value.start && idx <= selection.value.end;
                const getSlotClass = (tName, idx, status) => status === 'mine' ? 'slot-mine' : (status === 'o' ? 'slot-free' : 'slot-busy');
                const sortedTeachers = computed(() => {
                    let list = [...teachers.value];
                    if (sortByName.value) list.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    return list;
                });
                const formatTime = (idx) => timeSlots[idx] || "22:00";
                const resetSelection = () => selection.value = { teacherName: null, start: null, end: null };

                const submitBooking = async () => {
    submitting.value = true;
    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors', // ã“ã‚Œã‚’è¿½åŠ ï¼šGASç‰¹æœ‰ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆCORSï¼‰ã‚’å›é¿
            body: JSON.stringify({
                action: 'reserve',
                date: selectedDate.value,
                teacherName: selection.value.teacherName,
                startIdx: selection.value.start,
                endIdx: selection.value.end,
                userId: userLineId.value,
                userName: userName.value
            })
        });
        
        // mode: 'no-cors' ã®å ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ãŒã€
        // ã“ã“ã¾ã§æ¥ã‚Œã°é€ä¿¡è‡ªä½“ã¯æˆåŠŸã—ã¦ã„ã¾ã™ã€‚
        alert("äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ğŸ¯\nåæ˜ ã¾ã§æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
        resetSelection();
        setTimeout(loadData, 1500); // åæ˜ ã‚’å¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿
    } catch (e) {
        alert("é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    }
    submitting.value = false;
};

                const submitCancel = async (tName, idx) => {
                    loading.value = true;
                    try {
                        await fetch(GAS_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'cancel', date: selectedDate.value, teacherName: tName, slotIdx: idx, userId: userLineId.value })
                        });
                        alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†ã€‚");
                        loadData();
                    } catch (e) { alert("å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
                    loading.value = false;
                };

                onMounted(async () => {
                    try {
                        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®LIFF IDã‚’è¨­å®š ---
                        await liff.init({ liffId: "2008788046-laPjP0Ec" });
                        
                        if (!liff.isLoggedIn()) {
                            liff.login();
                        } else {
                            const profile = await liff.getProfile();
                            userName.value = profile.displayName;
                            userLineId.value = profile.userId;
                            loadData();
                        }
                    } catch (err) {
                        console.error("LIFF Init Error:", err);
                        alert("LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚IDè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    }
                });

                return { userName, selectedDate, timeSlots, sortedTeachers, loading, handleSlotClick, getSlotClass, isSelected, selection, resetSelection, formatTime, submitBooking, submitting, sortByName, loadData };
            }
        }).mount('#app');
    </script>
</body>
</html>

